<script>
// ... (SESLER VE PARÇACIK SINIFLARI AYNI KALIR) ...

// ====== GLOBAL BACKEND & SOL TABLO ======
const API_URL = "https://mistake-leaderboard.deno.dev";

async function skorGonder(d){
    try{
        await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});
        await sideTabloGuncelle();
    }catch(e){console.error(e);}
}

async function sideTabloGuncelle(){
    const ul = document.getElementById('sideList');
    const leaderboard = document.getElementById('sideLeaderboard');
    
    // Tabloyu sadece başlangıç ekranı (start) aktifse görünür yap
    if(document.getElementById('start').classList.contains('active')) {
        leaderboard.style.display = 'block';
    } else {
        leaderboard.style.display = 'none';
    }
    
    ul.innerHTML = '<li style="text-align:center; display:block; color:#00ffcc; font-weight:bold;">Yükleniyor...</li>';
    try {
        const r = await fetch(API_URL);
        if (!r.ok) throw new Error(`HTTP Error! Status: ${r.status}`);
        const data = await r.json();
        const top20 = data.slice(0, 20);
        
        ul.innerHTML = top20.map((e,i) => `
            <li>
                <span>${(i+1).toString().padStart(2, '0')}. ${e.nick.substring(0,10)}</span>
                <span style="color:#00ffcc">${e.skor.toLocaleString()}</span>
            </li>
        `).join('');
        
        if (top20.length === 0) {
             ul.innerHTML = '<li style="text-align:center; display:block; color:#666">Henüz skor yok! İlk sen ol.</li>';
        }
        
    } catch(e) {
        console.error("Sıralama yüklenirken hata:", e);
        ul.innerHTML = '<li style="text-align:center; display:block; color:#ff4444; font-weight:bold;">BAĞLANTI HATASI</li>';
    }
}
// Başlangıçta tabloyu çek ve görünür yap
sideTabloGuncelle();

// ... (KELİME SINIFI, PARTİKÜL SINIFI VE OYUN DEĞİŞKENLERİ AYNI KALIR) ...

// ====== BUTONLAR (GÜNCELLENMİŞ) ======
document.getElementById('basla').onclick=()=>{
    document.getElementById('start').classList.remove('active');
    document.getElementById('sideLeaderboard').style.display = 'none'; // OYUN BAŞLAYINCA KESİNLİKLE GİZLE
    initGame();
}

document.getElementById('nextLevel').onclick=()=>{
    // ... (AYNI KALIR) ...
}

function initGame(){
    // ... (AYNI KALIR) ...
}

// ... (KLAVYE, BOLUMTAMAM AYNI KALIR) ...

function oyunBitti(kelime){
    if(isGameOver) return; 
    isGameOver = true;
    oyunBasladi = false;
    oynat('gameover');
    
    // ... (AĞIR ÇEKİM VE FADE EFEKTİ AYNI KALIR) ...
    
    document.getElementById('toplamPuan').textContent=totalScore.toLocaleString();
    // Oyun Bitti Ekranında görünmesine izin verilmiyor.
}

// SADECE KAYDET, TABLO GÖSTERME (GÜNCELLENMİŞ)
document.getElementById('gonder').addEventListener('click', async()=>{
    const nick=document.getElementById('nick').value.trim()||'Anon';
    const btn = document.getElementById('gonder');
    btn.textContent = "KAYDEDİLİYOR...";
    btn.disabled = true;
    
    await skorGonder({
        nick:nick.substring(0,12),
        skor:totalScore,
        kelime:completedWordsTotal,
        hata:hataSayisi,
        level:sonTamamlananLevel
    });
    
    alert("Skorun kaydedildi!");
    
    // Oyun Bitti Ekranından Ana Menüye dön
    document.getElementById('bitti').classList.remove('active');
    document.getElementById('start').classList.add('active');
    document.getElementById('sideLeaderboard').style.display = 'block'; // Ana Menüye dönünce göster
    
    // OYUNU TEMİZLE
    initGame();
    oyunBasladi = false;
    isGameOver = false;

    // Geri dönen kullanıcının HUD'unu temizle (Görünmeyecek ama sıfırlansın)
    document.getElementById('puan').innerText = `PUAN: 0`;
    document.getElementById('hataCarpan').innerHTML = `HATA: 0 | ÇARPAN: <span style="color:#ff0044">1.00x</span>`;
    document.getElementById('levelInfo').innerText = `BÖLÜM 1 • 0/10`;
});

// ... (MAIN LOOP AYNI KALIR) ...

loop();

</script>
